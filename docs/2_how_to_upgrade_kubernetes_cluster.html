<!DOCTYPE html><html><head><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-151182268-2"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-151182268-2');</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="keywords" content="Rust,Electron,Web,TypeScript,JavaScript,Python,Golang,NodeJS,Kubernetes,Docker"><meta name="description" content="![kubernetes](/static/img/kubernetes_logo.png)You don&#x27;t need to upgrade the Kubernetes cluster in most time, there is no reason to upgrading if they running in stable, sometime we need to upgrade it for some bugs fixed and features. If you already have a running cluster and you want to upgrade it, t"><meta http-equiv="X-UA-Compatible" content="edge"><meta name="renderer" content="webkit"><meta http-equiv="Content-Language" content="zh-CN"><meta name="author" content="Nicholas Lee"><title>How to upgrade Kubernetes cluster - ITVOP</title><style type="text/css">*{margin:0;padding:0;text-decoration:none}a{color:#333}a:hover{color:#851d1c}table{border-spacing:0}body{font:1.1rem/1.5 Helvetica,Microsoft YaHei,Arial,sans-serif;color:#333}.app-footer{padding:1rem 0;width:100%;background-color:#851d1c;color:#fff}.app-footer .app-footer-ad{text-align:center}.app-footer .app-footer-ad a{color:#fff}.ad-keyword{padding-bottom:.1rem;border-bottom:1px solid #fff}.app .app-line1,.app hr{border:none;display:block;height:1px;width:100%;margin:1rem auto;background-color:#ddd}.app .app-line2{border:none;height:2px;width:100%;margin:1rem auto;background-color:#ddd}.app .app-header{width:100%}.app .app-header .app-nav{border-bottom:1px solid #f5f5f5;margin:0 auto;padding:0 1rem;width:1200px;padding:.5rem 0;display:flex;align-items:center;justify-content:space-between}.app .app-header .app-nav .app-logo{display:flex;align-items:center;justify-content:center}.app .app-header .app-nav .app-logo .app-logo-image{height:2em}.app .app-header .app-nav .app-logo .app-logo-title{white-space:nowrap;margin-left:.5rem;font-size:1.3rem;color:#999}.app .app-header .app-nav .app-nav-menu .ad-keyword{border-bottom:1px solid #851d1c;color:#851d1c}.app .app-header .app-nav .app-nav-menu a{margin-left:1rem;color:#999}.app .app-header .app-nav .app-nav-menu a:hover{color:#851d1c}.app .app-header .app-brand{width:100%;padding:1.5rem 0 2rem 0;display:flex;align-items:center;justify-content:center;font-size:3rem;color:#fff;background-color:#851d1c;box-shadow:0 0 1px 1px #999}.app .app-body{overflow-x:hidden;margin:0 1rem;width:1200px;margin:1rem auto;display:flex;justify-content:space-between}.app .app-body .app-container{width:0;flex:1}.app .app-body .app-container .app-page{display:flex;flex-wrap:wrap}.app .app-body .app-container .app-page a{margin-bottom:1rem;background-color:#fafafa;padding:.3rem .8rem;margin-right:1rem}.app .app-body .app-container .app-page a.app-page-active{background-color:#851d1c;color:#fff}.app .app-body .app-side{width:250px;margin-left:1rem}.app .app-body .app-side .app-side-item{padding:1rem;background-color:#fafafa;margin-bottom:1rem}.app .app-body .app-side .app-side-item .app-side-title{font-size:1.2rem;margin-bottom:.5rem;color:#851d1c}.app .app-body .app-side .app-side-item .app-side-title:before{content:"■ "}.app .app-body .app-side .app-side-item .app-side-list li{list-style:circle;margin-bottom:.3rem}.app-article-list .app-article{padding:1rem;background-color:#fafafa;margin-bottom:1rem}.app-article-list .app-article-list-tools .app-article-link{text-align:center;text-decoration:underline}.app-article .app-article-header .app-article-property .app-article-tag{margin-top:1rem;margin-right:.5rem}.app-article .app-article-header .app-article-property .app-article-tag a{margin-top:.5rem;display:inline-block}.app-article .app-article-header .app-article-property .app-article-tag a span{font-size:.8rem;margin-right:.5rem;color:#fff;padding:.5rem .5rem .3rem .5rem}.app-article .app-article-header .app-article-property .app-article-date{margin-right:1rem;color:#999}.app-article .app-article-header .app-article-title{margin-top:2rem;font-size:2rem}.app-article .app-article-header .app-article-title a{color:#851d1c}.app-article .app-article-content{display:block;padding-bottom:2rem;font-size:1rem;overflow:hidden}.app-article .app-article-content img{float:right;max-width:50%;margin-left:1rem;margin-bottom:1rem;height:auto;max-height:100%}.app-article .app-article-content img[alt=full]{margin-left:0;float:none;max-width:100%;height:auto}.app-article .app-article-content a{color:#851d1c;cursor:pointer;padding-bottom:.1rem;border-bottom:1px solid #851d1c}.app-article .app-article-content ul{margin-left:1.5rem;margin-top:1rem}.app-article .app-article-content ul li ul{margin-top:0}.app-article .app-article-content blockquote code,.app-article .app-article-content div code,.app-article .app-article-content p code,.app-article .app-article-content ul code{color:#851d1c;font-family:Helvetica,Microsoft YaHei,Arial,sans-serif}.app-article .app-article-content blockquote{margin:1rem 0;padding:.3rem 1rem;background-color:#fafafa;border-left:.2rem solid #999}.app-article .app-article-content table{width:100%;margin:1rem 0;border-right:1px solid #ddd}.app-article .app-article-content table thead{background-color:#ddd}.app-article .app-article-content table thead tr th{font-weight:400;text-align:center;padding:.5rem .3rem}.app-article .app-article-content table tbody tr td{padding:.5rem .3rem;border-left:1px solid #ddd;border-bottom:1px solid #ddd}.app-article .app-article-content pre{margin-top:1rem;margin-bottom:2rem}.app-article .app-article-content h1{font-weight:400}.app-article .app-article-content h2,.app-article .app-article-content h3{font-weight:400;margin-top:2rem}.app-article .app-article-content h2:first-child,.app-article .app-article-content h3:first-child{margin-top:1rem}.app-article .app-article-content p{line-height:1.8rem;margin:1rem auto}.app-article .app-article-notice{padding:1rem;background-color:#fafafa;border-left:.1rem solid #851d1c}.app-article .app-article-notice a{color:#851d1c;word-break:break-all}.app-article .app-random{display:flex}.app-article .app-random .app-random-item{padding:1rem 0;flex:.5}.app-article .app-random .app-random-item:last-child{text-align:right}.app-article .app-share{margin:2rem 0;overflow:auto}.app-article-intro .app-article-content table{border-right:1px solid #e8e3e3}.app-article-intro .app-article-content table thead{background-color:#e8e3e3}.app-article-intro .app-article-content table tbody tr td{border-left:1px solid #e8e3e3;border-bottom:1px solid #e8e3e3}@media (max-width:1220px){.app{padding:0 1rem}.app .app-header .app-nav{z-index:999999999;position:fixed;left:0;top:0;background-color:#fff;padding:1rem;box-sizing:border-box;width:100%}.app .app-header .app-brand{margin-top:80px}.app .app-body{margin-top:80px;width:100%}}@media (max-width:430px){.app .app-header .app-nav .app-nav-menu a{display:none}.app .app-header .app-nav .app-nav-menu a.nav-menu-posts{display:inline}}@media (max-width:600px){.app .app-header .ad-link,.app .app-header .app-brand{display:none}.app-article .app-article-header .app-article-property .app-article-date{padding:.5rem 0}.app-article .app-article-content p img{display:block;margin-left:0;float:none;max-width:100%}}@media (max-width:800px){.app .app-body .app-container{flex:1;width:100%}.app .app-body .app-side{display:none}}@media (max-width:900px){.app .app-body .app-side{width:200px}}
    .hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style></head><body><div class="app"><div class="app-header"><div class="app-nav"><a class="app-logo" href="https://itvop.com"><img class="app-logo-image" src="/images/logo.png"> <span class="app-logo-title">ITVOP</span></a><div class="app-nav-menu"><a class="ad-link" target="_blank" href="https://twitter.com/lizhongit">Twitter</a> <a href="https://itvop.com/about.html">ABOUT</a> <a href="/rss.xml" target="__blank">RSS</a> <a href="/posts.html" class="nav-menu-posts" target="__blank">POSTS</a></div></div><div class="app-brand">Hot For Coding</div></div><div class="app-body"><div class="app-container app-article"><div class="app-article-header"><div class="app-article-property"><div class="app-article-date">November 18, 2019</div></div><div class="app-article-title">How to upgrade Kubernetes cluster</div></div><div class="app-line2"></div><div class="app-article-content"><p><img src="/static/img/kubernetes_logo.png" alt="kubernetes"></p><p>You don't need to upgrade the Kubernetes cluster in most time, there is no reason to upgrading if they running in stable, sometime we need to upgrade it for some bugs fixed and features. If you already have a running cluster and you want to upgrade it, there are three steps of work to do.</p><h2>Step 1: Get the upgrade plan</h2><p>You should get the upgrade plan with kubeadm command, run below command in one of master nodes to get the upgrade plan</p><pre class="hljs"><code class="shell">kubeadm upgrade plan
</code></pre><p>You should see something in stdout including like <code>You can now apply the upgrade by executing the following command</code> aflter you run it, it will list all the avaliable plan for upgrade at once. For example, here is in my case</p><pre class="hljs"><code class="shell">node4 ~ # kubeadm upgrade plan
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade] Fetching available versions to upgrade to
[upgrade/versions] Cluster version: v1.16.2
[upgrade/versions] kubeadm version: v1.16.2
[upgrade/versions] Latest stable version: v1.16.3
[upgrade/versions] Latest version in the v1.16 series: v1.16.3

External components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT   AVAILABLE
Etcd        3.3.10    3.3.15-0

Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT        AVAILABLE
Kubelet     15 x v1.16.2   v1.16.3

Upgrade to the latest version in the v1.16 series:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.16.2   v1.16.3
Controller Manager   v1.16.2   v1.16.3
Scheduler            v1.16.2   v1.16.3
Kube Proxy           v1.16.2   v1.16.3
CoreDNS              1.6.2     1.6.2

You can now apply the upgrade by executing the following command:

        kubeadm upgrade apply v1.16.3

Note: Before you can perform this upgrade, you have to update kubeadm to v1.16.3.
</code></pre><p>If there is a plan of the available list you want to continue, please, move the step 2</p><h2>Step 2: Download the kubeadm</h2><p>You will get a version from the upgrade plan, So we need to update kubeadm to the version, this work is just simplest, we can get the kubeadm from here: <img src="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" alt="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">.</p><p>We keep going to Step 3 when you are get a binary of kubeadm.</p><h2>Step 3: Upgrading with kubeadm</h2><p>Now we can run a command which from Step 1 to got it to upgrade the cluster, For example, I'll upgrade my cluster from v1.16.2 to v1.16.3 in my case.</p><pre class="hljs"><code class="shell">node4 ~ # kubeadm upgrade apply v1.16.3
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade/version] You have chosen to change the cluster version to "v1.16.3"
[upgrade/versions] Cluster version: v1.16.2
[upgrade/versions] kubeadm version: v1.16.3
[upgrade/confirm] Are you sure you want to proceed with the upgrade? [y/N]: y
[upgrade/prepull] Will prepull images for components [kube-apiserver kube-controller-manager kube-scheduler]
[upgrade/prepull] Prepulling image for component kube-scheduler.
[upgrade/prepull] Prepulling image for component kube-apiserver.
[upgrade/prepull] Prepulling image for component kube-controller-manager.
[apiclient] Found 0 Pods for label selector k8s-app=upgrade-prepull-kube-controller-manager
[apiclient] Found 3 Pods for label selector k8s-app=upgrade-prepull-kube-apiserver
[apiclient] Found 0 Pods for label selector k8s-app=upgrade-prepull-kube-scheduler
[apiclient] Found 3 Pods for label selector k8s-app=upgrade-prepull-kube-controller-manager
[apiclient] Found 3 Pods for label selector k8s-app=upgrade-prepull-kube-scheduler
[upgrade/prepull] Prepulled image for component kube-apiserver.
[upgrade/prepull] Prepulled image for component kube-controller-manager.
[upgrade/prepull] Prepulled image for component kube-scheduler.
[upgrade/prepull] Successfully prepulled the images for all the control plane components
[upgrade/apply] Upgrading your Static Pod-hosted control plane to version "v1.16.3"...
Static pod: kube-apiserver-node4 hash: 95960acc2c1b28de33ffa5714d927752
Static pod: kube-controller-manager-node4 hash: db76afd7d7adb4351dc71a27eaccae8b
Static pod: kube-scheduler-node4 hash: 74dea8da17aa6241e5e4f7b2ba4e1d8e
[upgrade/staticpods] Writing new Static Pod manifests to "/etc/kubernetes/tmp/kubeadm-upgraded-manifests234740264"
[upgrade/staticpods] Preparing for "kube-apiserver" upgrade
[upgrade/staticpods] Renewing apiserver certificate
[upgrade/staticpods] Renewing apiserver-kubelet-client certificate
[upgrade/staticpods] Renewing front-proxy-client certificate
[upgrade/staticpods] Moved new manifest to "/etc/kubernetes/manifests/kube-apiserver.yaml" and backed up old manifest to "/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-11-18-09-10-29/kube-apiserver.yaml"
[upgrade/staticpods] Waiting for the kubelet to restart the component
[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)
Static pod: kube-apiserver-node4 hash: 95960acc2c1b28de33ffa5714d927752
Static pod: kube-apiserver-node4 hash: 0a655ff3baac3464c9e8cecebd3e39ed
[apiclient] Found 3 Pods for label selector component=kube-apiserver
[upgrade/staticpods] Component "kube-apiserver" upgraded successfully!
[upgrade/staticpods] Preparing for "kube-controller-manager" upgrade
[upgrade/staticpods] Renewing controller-manager.conf certificate
[upgrade/staticpods] Moved new manifest to "/etc/kubernetes/manifests/kube-controller-manager.yaml" and backed up old manifest to "/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-11-18-09-10-29/kube-controller-manager.yaml"
[upgrade/staticpods] Waiting for the kubelet to restart the component
[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)
Static pod: kube-controller-manager-node4 hash: db76afd7d7adb4351dc71a27eaccae8b
Static pod: kube-controller-manager-node4 hash: 2691e4f51ee24e8c610557d2266dcbd5
[apiclient] Found 3 Pods for label selector component=kube-controller-manager
[upgrade/staticpods] Component "kube-controller-manager" upgraded successfully!
[upgrade/staticpods] Preparing for "kube-scheduler" upgrade
[upgrade/staticpods] Renewing scheduler.conf certificate
[upgrade/staticpods] Moved new manifest to "/etc/kubernetes/manifests/kube-scheduler.yaml" and backed up old manifest to "/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-11-18-09-10-29/kube-scheduler.yaml"
[upgrade/staticpods] Waiting for the kubelet to restart the component
[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)
Static pod: kube-scheduler-node4 hash: 74dea8da17aa6241e5e4f7b2ba4e1d8e
Static pod: kube-scheduler-node4 hash: 4e1bd6e5b41d60d131353157588ab020
[apiclient] Found 3 Pods for label selector component=kube-scheduler
[upgrade/staticpods] Component "kube-scheduler" upgraded successfully!
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
[kubelet] Creating a ConfigMap "kubelet-config-1.16" in namespace kube-system with the configuration for the kubelets in the cluster
[kubelet-start] Downloading configuration for the kubelet from the "kubelet-config-1.16" ConfigMap in the kube-system namespace
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[addons]: Migrating CoreDNS Corefile
[addons] Applied essential addon: CoreDNS
[endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address
[addons] Applied essential addon: kube-proxy

[upgrade/successful] SUCCESS! Your cluster was upgraded to "v1.16.3". Enjoy!

[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven't already done so.
</code></pre><p>If you could see like <code>[upgrade/successful] SUCCESS! Your cluster was upgraded to &quot;vX.X.X&quot;. Enjoy!</code> in the last stdout, it has been done for upgrade!</p><h2>Notes</h2><p>There is a easy to make mistakes just only downloaing the kubeadm, you will see the new version by the command <code>kubectl get nodes</code> after downloaded the kubeadm, kubectl and kubelet for all the nodes. In fact, it really not a new version for working, You have to run command <code>kubeadm upgrade apply vX.X.X</code> for the last step.</p><p>The new versions of Kubernetes isn't stable, this is a the most important. I have heavy pay for it, I upgrade my cluster tow months ago, there are tow problems I can't do something for it for a long time.</p><ul><li>1、The Pods of Complated status isn't auto remove, But it always keep last three pods of Complated status in older version. For now, I doing by the Crontab</li><li>2、The containers of Gitlab-Runner exit with code 137 even I given it enough Memory and CPU in sometime, here is my opened's issue: <img src="https://gitlab.com/gitlab-org/charts/gitlab-runner/issues/114" alt="https://gitlab.com/gitlab-org/charts/gitlab-runner/issues/114"></li></ul><h2>Updated in November 28, 2019</h2><p>About the Pods of Complated status isn't auto clean on the CronJob, I have been find out what is happing. it don't matter with Kubernetes, it's on the Etcd, it's version too old dons’t support the latest Kubernetes versions. I’m fixed that by upgrade the Etcd to the latest version.</p></div><div class="app-line1"></div><div class="app-share"></div><div class="app-article-notice"><p>TITLE: <a href="https://itvop.com/2_how_to_upgrade_kubernetes_cluster.html">How to upgrade Kubernetes cluster</a></p><p>LINK: <a href="https://itvop.com/2_how_to_upgrade_kubernetes_cluster.html">https://itvop.com/2_how_to_upgrade_kubernetes_cluster.html</a></p><p>NOTE: I'm new in English, anything like grammar and words if incorrect please let me know.</p></div><div class="app-random"><div class="app-random-item"><a href="https://itvop.com/3_a_bad_day_from_uprading_the_etcd_for_kubernetes.html">A bad day from upgrading the Etcd for my Kubernetes cluster</a></div><div class="app-random-item"><a href="https://itvop.com/4_nginx_proxy_redirect_replace_location_field_in_header.html">Using the proxy_redirect module to replace the field Location in response&#x27;s header on Nginx</a></div></div><div class="app-line1"></div><div><div id="disqus_thread"></div></div></div><div class="app-side"><div class="app-side-item"><div class="app-side-title">Archivies</div><div class="app-side-list"><li><a href="https://itvop.com/archive_dec_2019_1.html">Dec, 2019 (1)</a></li><li><a href="https://itvop.com/archive_nov_2019_1.html">Nov, 2019 (4)</a></li></div></div></div></div></div><div class="app-footer"><div class="app-footer-ad"><a class="ad-link" target="_blank" href="https://twitter.com/lizhongit">Twitter</a></div></div><script>setTimeout(() => {
      var d = document, s = d.createElement('script');
      s.src = 'https://itvop.disqus.com/embed.js';
      s.async = true;
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    });</script></body></html>